syntax = "proto3";
package plugin.certificate_issuer.v1;

import "google/protobuf/duration.proto";
import "google/protobuf/timestamp.proto";

service CertificateIssuer {
  rpc IssueCertificate(IssueCertificateRequest) returns (IssueCertificateResponse);
}

message IssueCertificateRequest {
  CertificateLifetime lifetime = 1;
  Subject subject = 2;
  PrivateKey private_key = 3;
  CertificateFormat preferred_format = 4;

  enum CertificateFormat {
    CERTIFICATE_FORMAT_UNSPECIFIED = 0;
    PEM = 1;
    DER = 2;
    PKCS7 = 3;
  }
}

message IssueCertificateResponse {
  bytes certificate_data = 1;
  IssueCertificateRequest.CertificateFormat format = 2;
  repeated bytes ca_chain = 3;
}

message Subject {
  string common_name = 1;
  optional string serial_number = 2;
  repeated string country = 3;
  repeated string organization = 4;
  repeated string organizational_unit = 5;
  repeated string locality = 6;
  repeated string province = 7;
  repeated string street_address = 8;
  repeated string postal_code = 9;
}

message PrivateKey {
  bytes data = 1;
  KeyFormat format = 2;

  enum KeyFormat {
    KEY_FORMAT_UNSPECIFIED = 0;
    PKCS1 = 1;
    PKCS8 = 2;
    SEC1 = 3;
  }
}

message CertificateLifetime {
  oneof lifetime {
    google.protobuf.Duration duration = 1;
    google.protobuf.Timestamp not_after = 2;
    RelativeValidity relative = 3;
  }
}

message RelativeValidity {
  int32 value = 1;
  ValidityUnit unit = 2;

  enum ValidityUnit {
    VALIDITY_UNIT_UNSPECIFIED = 0;
    DAYS = 1;
    MONTHS = 2;
    YEARS = 3;
  }
}

message SupportedKeyFormatsError {
  string rejected_format = 1;
  repeated PrivateKey.KeyFormat supported_formats = 2;
  string reason = 3;
}